{% extends "base.html" %}
{% block content %}

<h2 class="mb-4">Inserisci Gomme</h2>

<div class="container">

    <!-- FORM INSERIMENTO GOMME -->
    <form id="form-gomme" method="POST" action="{{ url_for('inserisci_gomme') }}" class="border p-4 rounded shadow-sm bg-light">

        <div class="mb-3">
            <label class="form-label fw-bold">Marca</label>
            <select name="marca" class="form-select" required>
                <option value="">Seleziona marca...</option>
                {% for m in marche %}
                <option value="{{ m }}" {% if request.form.marca == m %}selected{% endif %}>{{ m }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">Larghezza</label>
                <input type="text" class="form-control" name="larghezza" required
                       pattern="\d{3}" placeholder="Esempio: 205"
                       value="{{ request.form.larghezza or '' }}">
            </div>

            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">Rapporto</label>
                <input type="text" class="form-control" name="rapporto" required
                       pattern="\d{2}" placeholder="Esempio: 55"
                       value="{{ request.form.rapporto or '' }}">
            </div>

            <div class="col-md-4 mb-3">
                <label class="form-label fw-bold">Diametro</label>
                <input type="text" class="form-control" name="diametro" required
                       pattern="\d{2}" placeholder="Esempio: 16"
                       value="{{ request.form.diametro or '' }}">
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Prezzo Unitario (€)</label>
                <input type="number" class="form-control" step="0.01" name="prezzo_unitario" required
                       value="{{ request.form.prezzo_unitario or '' }}">
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Prezzo Treno (€)</label>
                <input type="number" class="form-control" step="0.01" name="prezzo_treno" required
                       value="{{ request.form.prezzo_treno or '' }}">
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Disponibilità (0–99)</label>
            <input type="number" class="form-control" name="disponibilita" min="0" max="99" required
                   value="{{ request.form.disponibilita or '' }}">
        </div>

        <div class="mb-3">
            <label class="form-label fw-bold">Note</label>
            <textarea class="form-control" name="note" rows="2" placeholder="Note aggiuntive...">{{ request.form.note or '' }}</textarea>
        </div>

        <button type="submit" class="btn btn-primary mt-2">Inserisci Gomma</button>
    </form>

    <hr class="my-5">

    <!-- TABELLA GOMME GIÀ INSERITE -->
    <h3 class="mb-3">Gomme Registrate</h3>

    {% if gomme %}
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Marca</th>
                <th>Misura</th>
                <th>Prezzo Unitario</th>
                <th>Prezzo Treno</th>
                <th>Disponibilità</th>
                <th>Note</th>
                <th>Data Inserimento</th>
            </tr>
        </thead>
        <tbody>
            {% for g in gomme %}
            <tr>
                <td>{{ g.marca }}</td>
                <td>{{ g.larghezza }}/{{ g.rapporto }} R{{ g.diametro }}</td>
                <td>{{ "%.2f"|format(g.prezzo_unitario) }} €</td>
                <td>{{ "%.2f"|format(g.prezzo_treno) }} €</td>
                <td>{{ g.disponibilita }}</td>
                <td>{{ g.note }}</td>
                <td>{{ g.data_creazione.strftime("%d/%m/%Y %H:%M") }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>Nessuna gomma inserita.</p>
    {% endif %}

</div>

<script>
document.getElementById('form-gomme').addEventListener('submit', function(e) {
    let errors = [];

    const larghezza = this.larghezza.value;
    const rapporto = this.rapporto.value;
    const diametro = this.diametro.value;
    const prezzoUnitario = parseFloat(this.prezzo_unitario.value);
    const prezzoTreno = parseFloat(this.prezzo_treno.value);
    const disponibilita = parseInt(this.disponibilita.value);

    if(!/^\d{3}$/.test(larghezza)) errors.push("Larghezza deve essere esattamente 3 cifre");
    if(!/^\d{2}$/.test(rapporto)) errors.push("Rapporto deve essere esattamente 2 cifre");
    if(!/^\d{2}$/.test(diametro)) errors.push("Diametro deve essere esattamente 2 cifre");
    if(isNaN(prezzoUnitario) || prezzoUnitario <= 0) errors.push("Prezzo unitario deve essere maggiore di 0");
    if(isNaN(prezzoTreno) || prezzoTreno <= 0) errors.push("Prezzo treno deve essere maggiore di 0");
    if(isNaN(disponibilita) || disponibilita < 0 || disponibilita > 99) errors.push("Disponibilità deve essere tra 0 e 99");

    if(errors.length > 0){
        alert("Errore:\n- " + errors.join("\n- "));
        e.preventDefault();
        return false;
    }
});
</script>

{% endblock %}
