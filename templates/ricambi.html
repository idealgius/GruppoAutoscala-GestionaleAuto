{% extends "base.html" %}

{% block title %}Ricambi{% endblock %}

{% block content %}
<h1>🔧 Elenco Ricambi</h1>

<!-- Filtro prefisso (facoltativo) -->
<form method="GET" action="/ricambi" style="margin-bottom:12px; display:flex; align-items:center; gap:8px;">
  <select name="prefisso" style="padding:6px; min-width:180px;">
    <option value="">-- Filtra per prefisso (facoltativo) --</option>
    <option value="BH" {% if request.args.get('prefisso') == 'BH' %}selected{% endif %}>BH</option>
    <option value="MM" {% if request.args.get('prefisso') == 'MM' %}selected{% endif %}>MM</option>
  </select>
  <button type="submit" class="button" style="padding:6px 12px;">📌 Filtra</button>
</form>

<!-- Barra di ricerca per codice o ultime cifre -->
<form method="GET" action="/ricambi" style="margin-bottom:16px; display:flex; align-items:center; gap:8px;">
    <input type="text" name="q" placeholder="Cerca per codice o ultime cifre..." value="{{ request.args.get('q', '') }}" style="flex:1; padding:6px;">
    <button type="submit" class="button" style="padding:6px 12px;">🔍 Cerca</button>
</form>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap: wrap;">
  <a href="/inserisci_ricambio" class="button">➕ Inserisci Ricambio</a>
</div>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Nome</th>
      <th>Codice</th>
      <th>Quantità</th>
      <th>Azioni</th>
    </tr>
  </thead>
  <tbody>
    {% if ricambi %}
      {% for r in ricambi %}
      <tr {% if request.args.get('q') and request.args.get('q').lower() in r['codice'].lower() %} style="background-color:#ffff99;" {% endif %}>
        <td>{{ r['id'] }}</td>
        <td>{{ r['nome'] }}</td>
        <td>
            {{ r['codice'] }}
            {% if r.get('collegato_a') %}
              <span style="color:blue; font-weight:bold;">🔗 collegato a {{ r['collegato_a'] }}</span>
            {% endif %}
        </td>
        <td>
          {{ r['quantita'] }}
          {% if r['quantita'] <= 2 %}
            {% if r['quantita'] == 0 %}
              <span style="color:red; font-weight:bold;">❌ Esaurito</span>
            {% elif r['quantita'] == 1 %}
              <span style="color:orange; font-weight:bold;">⚠️ Solo 1 rimasto</span>
            {% else %}
              <span style="color:orange; font-weight:bold;">⚠️ Giacenza bassa</span>
            {% endif %}
          {% endif %}
        </td>
        <td class="action-buttons">
          <a href="/modifica_ricambio/{{ r['id'] }}" class="modifica">✏️ Modifica</a>
          <a href="/elimina_ricambio/{{ r['id'] }}" class="elimina" onclick="return confirm('Eliminare questo ricambio?')">🗑️ Elimina</a>
        </td>
      </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="5" style="text-align:center;">Nessun ricambio registrato.</td>
      </tr>
    {% endif %}
  </tbody>
</table>
{% endblock %}
