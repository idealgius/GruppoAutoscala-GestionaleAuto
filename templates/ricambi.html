{% extends "base.html" %}

{% block title %}Ricambi{% endblock %}

{% block content %}
<h1>üîß Elenco Ricambi</h1>

<!-- Filtro prefisso e barra di ricerca in un unico form -->
<form method="GET" action="/ricambi" style="margin-bottom:16px; display:flex; align-items:center; gap:8px; flex-wrap: wrap;">
  <select name="prefisso" style="padding:6px; min-width:180px;">
    <option value="">-- Filtra per prefisso (facoltativo) --</option>
    <option value="BH" {% if filtro_prefisso == 'BH' %}selected{% endif %}>BH</option>
    <option value="MM" {% if filtro_prefisso == 'MM' %}selected{% endif %}>MM</option>
    <option value="COF" {% if filtro_prefisso == 'COF' %}selected{% endif %}>COF</option>
    <option value="XEN" {% if filtro_prefisso == 'XEN' %}selected{% endif %}>XEN</option>
    <option value="MIC" {% if filtro_prefisso == 'MIC' %}selected{% endif %}>MIC</option>
  </select>

  <input type="text" name="q" placeholder="Cerca per codice o ultime cifre..." value="{{ ricerca }}" style="flex:1; padding:6px;">
  
  <button type="submit" class="button" style="padding:6px 12px;">üîç Applica</button>

  {% if ricerca or filtro_prefisso %}
    <a href="/ricambi" class="button" style="padding:6px 12px; background-color:#ccc;">üîÑ Reset</a>
  {% endif %}
</form>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap: wrap;">
  <a href="/inserisci_ricambio" class="button">‚ûï Inserisci Ricambio</a>
</div>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Nome</th>
      <th>Codice</th>
      <th>Quantit√†</th>
      <th>Azioni</th>
    </tr>
  </thead>
  <tbody>
    {% if ricambi %}
      {% for r in ricambi %}
      <tr>
        <td>{{ r['id'] }}</td>
        <td>{{ r['nome']|safe }}</td>
        <td>{{ r['codice']|safe }}</td>
        <td>
          {{ r['quantita'] }}
          {% if r['quantita'] <= 2 %}
            {% if r['quantita'] == 0 %}
              <span class="badge danger">‚ùå Esaurito</span>
            {% elif r['quantita'] == 1 %}
              <span class="badge warning">‚ö†Ô∏è Solo 1 rimasto</span>
            {% else %}
              <span class="badge low-stock">‚ö†Ô∏è Giacenza bassa</span>
            {% endif %}
          {% endif %}

          {% if session.get('username') == 'G.AS_Giuseppe.Palladino' %}
          <!-- Pulsanti gestione giacenze -->
          <div style="display:inline-flex; gap:4px; margin-left:6px;">
            <form method="POST" action="/ricambi/aggiorna_giacenza/{{ r['id'] }}" style="display:inline;">
              <input type="hidden" name="azione" value="incrementa">
              <button type="submit" class="button" style="padding:2px 6px; font-size:0.8em;">‚ûï</button>
            </form>
            <form method="POST" action="/ricambi/aggiorna_giacenza/{{ r['id'] }}" style="display:inline;">
              <input type="hidden" name="azione" value="decrementa">
              <button type="submit" class="button" style="padding:2px 6px; font-size:0.8em;">‚ûñ</button>
            </form>
            <form method="POST" action="/ricambi/aggiorna_giacenza/{{ r['id'] }}" style="display:inline;">
              <input type="number" name="nuova_quantita" min="0" style="width:50px; padding:2px;">
              <button type="submit" class="button" style="padding:2px 6px; font-size:0.8em;">‚úèÔ∏è</button>
            </form>
          </div>
          {% endif %}
        </td>

        <td class="action-buttons">
          <a href="/modifica_ricambio/{{ r['id'] }}" class="modifica-btn">‚úèÔ∏è</a>
          <a href="/elimina_ricambio/{{ r['id'] }}" class="elimina-btn" onclick="return confirm('Eliminare questo ricambio?')">üóëÔ∏è</a>
        </td>
      </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="5" style="text-align:center; color:red;">Il codice che stai cercando non √® presente.</td>
      </tr>
    {% endif %}
  </tbody>
</table>

<style>
.badge.danger { color: red; font-weight: bold; }
.badge.warning { color: orange; font-weight: bold; }
.badge.low-stock { color: darkorange; font-weight: bold; }

.action-buttons { display: flex; gap: 6px; justify-content: center; align-items: center; }

.modifica-btn {
  background-color: #f4a300;
  color: white;
  padding: 6px 10px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: bold;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.elimina-btn {
  background-color: #d9534f;
  color: white;
  padding: 6px 10px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: bold;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.modifica-btn:hover { background-color: #ffb700; }
.elimina-btn:hover { background-color: #c9302c; }
</style>

<!-- üî• SCRIPT PER NON PERDERE LA POSIZIONE DELLA PAGINA -->
<script>
// Salva la posizione dello scroll PRIMA di lasciare la pagina
window.addEventListener("beforeunload", function() {
    localStorage.setItem("scroll_ricambi", window.scrollY);
});

// Ripristina la posizione dello scroll al caricamento
window.addEventListener("load", function() {
    const pos = localStorage.getItem("scroll_ricambi");
    if (pos !== null) {
        window.scrollTo(0, parseInt(pos));
    }
});
</script>

{% endblock %}
