{% extends "base.html" %}

{% block title %}Ricambi{% endblock %}

{% block content %}
<h1>🔧 Elenco Ricambi</h1>

<!-- Filtro prefisso e barra di ricerca in un unico form -->
<form method="GET" action="/ricambi" style="margin-bottom:16px; display:flex; align-items:center; gap:8px; flex-wrap: wrap;">
  <select name="prefisso" style="padding:6px; min-width:180px;">
    <option value="">-- Filtra per prefisso (facoltativo) --</option>
    <option value="BH" {% if filtro_prefisso == 'BH' %}selected{% endif %}>BH</option>
    <option value="MM" {% if filtro_prefisso == 'MM' %}selected{% endif %}>MM</option>
    <option value="COF" {% if filtro_prefisso == 'COF' %}selected{% endif %}>COF</option>
    <option value="XEN" {% if filtro_prefisso == 'XEN' %}selected{% endif %}>XEN</option>
  </select>

  <input type="text" name="q" placeholder="Cerca per codice o ultime cifre..." value="{{ ricerca }}" style="flex:1; padding:6px;">
  
  <button type="submit" class="button" style="padding:6px 12px;">🔍 Applica</button>

  {% if ricerca or filtro_prefisso %}
    <a href="/ricambi" class="button" style="padding:6px 12px; background-color:#ccc;">🔄 Reset</a>
  {% endif %}
</form>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap: wrap;">
  <a href="/inserisci_ricambio" class="button">➕ Inserisci Ricambio</a>
</div>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Nome</th>
      <th>Codice</th>
      <th>Quantità</th>
      <th>Azioni</th>
    </tr>
  </thead>
  <tbody>
    {% if ricambi %}
      {% for r in ricambi %}
      <tr>
        <td>{{ r['id'] }}</td>
        <td>{{ r['nome']|safe }}</td>
        <td>{{ r['codice']|safe }}</td>
        <td>
          {{ r['quantita'] }}
          {% if r['quantita'] <= 2 %}
            {% if r['quantita'] == 0 %}
              <span class="badge danger">❌ Esaurito</span>
            {% elif r['quantita'] == 1 %}
              <span class="badge warning">⚠️ Solo 1 rimasto</span>
            {% else %}
              <span class="badge low-stock">⚠️ Giacenza bassa</span>
            {% endif %}
          {% endif %}
        </td>
        <td class="action-buttons">
          <a href="/modifica_ricambio/{{ r['id'] }}" class="modifica">✏️ Modifica</a>
          <a href="/elimina_ricambio/{{ r['id'] }}" class="elimina" onclick="return confirm('Eliminare questo ricambio?')">🗑️ Elimina</a>
        </td>
      </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="5" style="text-align:center; color:red;">Il codice che stai cercando non è presente.</td>
      </tr>
    {% endif %}
  </tbody>
</table>

<style>
.badge.danger { color: red; font-weight: bold; }
.badge.warning { color: orange; font-weight: bold; }
.badge.low-stock { color: darkorange; font-weight: bold; }
.action-buttons a { margin-right:8px; text-decoration:none; }
</style>
{% endblock %}
