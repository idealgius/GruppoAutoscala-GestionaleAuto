{% extends "base.html" %}

{% block title %}Ricambi{% endblock %}

{% block content %}
<h1>üîß Elenco Ricambi</h1>

<!-- FILTRI -->
<form method="GET" action="/ricambi"
      style="margin-bottom:16px; display:flex; align-items:center; gap:8px; flex-wrap: wrap;">
  
  <select name="prefisso" class="select-filter">
    <option value="">-- Filtra per prefisso --</option>
    <option value="BH"  {% if filtro_prefisso == 'BH' %}selected{% endif %}>BH</option>
    <option value="MM"  {% if filtro_prefisso == 'MM' %}selected{% endif %}>MM</option>
    <option value="COF" {% if filtro_prefisso == 'COF' %}selected{% endif %}>COF</option>
    <option value="XEN" {% if filtro_prefisso == 'XEN' %}selected{% endif %}>XEN</option>
    <option value="MIC" {% if filtro_prefisso == 'MIC' %}selected{% endif %}>MIC</option>
    <option value="JAP" {% if filtro_prefisso == 'JAP' %}selected{% endif %}>JAP</option>
  </select>

  <input type="text" name="q" placeholder="Cerca per codice o ultima parte..."
         value="{{ ricerca }}" class="search-box">

  <button type="submit" class="button small">üîç Cerca</button>

  {% if ricerca or filtro_prefisso %}
    <a href="/ricambi" class="button small reset-btn">üîÑ Reset</a>
  {% endif %}
</form>

<!-- INSERISCI RICAMBIO -->
<div class="top-actions">
  <a href="/inserisci_ricambio" class="button add-btn">‚ûï Inserisci Ricambio</a>
</div>

<!-- TABELLA -->
<table class="styled-table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Nome</th>
      <th>Codice</th>
      <th>Quantit√†</th>
      <th>Azioni</th>
    </tr>
  </thead>
  <tbody>
    {% if ricambi %}
      {% for r in ricambi %}
      <tr>
        <td>{{ r['id'] }}</td>
        <td>{{ r['nome']|safe }}</td>

        <!-- CODICE + ICONA INFO -->
        <td>
          {{ r['codice']|safe }}

          {% if r.get('sost_codice') %}
          <button class="info-btn"
                  onclick="mostraInfo('{{ r['codice'] }}','{{ r['sost_codice'] }}')">
            ‚ÑπÔ∏è
          </button>
          {% endif %}
        </td>

        <td>
          {{ r['quantita'] }}

          {% if r['quantita'] <= 2 %}
            {% if r['quantita'] == 0 %}
              <span class="badge danger">‚ùå Esaurito</span>
            {% elif r['quantita'] == 1 %}
              <span class="badge warning">‚ö†Ô∏è Solo 1</span>
            {% else %}
              <span class="badge low-stock">‚ö†Ô∏è Bassa</span>
            {% endif %}
          {% endif %}

          {% if session.get('username') == 'G.AS_Giuseppe.Palladino' %}
          <div class="stock-buttons">
            <form method="POST" action="/ricambi/aggiorna_giacenza/{{ r['id'] }}">
              <input type="hidden" name="azione" value="incrementa">
              <button class="stock-btn">‚ûï</button>
            </form>
            <form method="POST" action="/ricambi/aggiorna_giacenza/{{ r['id'] }}">
              <input type="hidden" name="azione" value="decrementa">
              <button class="stock-btn">‚ûñ</button>
            </form>
            <form method="POST" action="/ricambi/aggiorna_giacenza/{{ r['id'] }}">
              <input type="number" name="nuova_quantita" min="0" class="stock-input">
              <button class="stock-btn">‚úèÔ∏è</button>
            </form>
          </div>
          {% endif %}
        </td>

        <td class="action-buttons">
          <a href="/modifica_ricambio/{{ r['id'] }}" class="modifica-btn">‚úèÔ∏è</a>
          <a href="/elimina_ricambio/{{ r['id'] }}" class="elimina-btn"
             onclick="return confirm('Eliminare questo ricambio?')">üóëÔ∏è</a>
        </td>
      </tr>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="5" class="no-results">Nessun ricambio trovato.</td>
      </tr>
    {% endif %}
  </tbody>
</table>

<!-- POPUP INFO -->
<div id="infoBox" class="info-popup">
  <h3>üîÅ Ricambio Alternativo</h3>
  <p id="infoContent"></p>
  <button onclick="chiudiInfo()" class="button small">Chiudi</button>
</div>

<style>
/* üîµ Migliorie estetiche */
.styled-table { width: 100%; border-collapse: collapse; }
.styled-table thead tr { background: #004c99; color: white; }
.styled-table td, .styled-table th { padding: 10px; border-bottom: 1px solid #ccc; }

.select-filter, .search-box { padding: 6px; border-radius: 6px; border: 1px solid #bbb; }

.button.small { padding: 6px 10px; font-size: 0.9em; }
.reset-btn { background: #999; }

.add-btn { background: #1b8f3e; color: white; }

.info-btn {
  background: #0066cc;
  border: none;
  border-radius: 6px;
  color: white;
  padding: 2px 6px;
  font-size: 0.8em;
  margin-left: 6px;
  cursor: pointer;
}
.info-btn:hover { background: #3388dd; }

.badge { font-weight: bold; margin-left: 6px; }
.badge.danger { color: red; }
.badge.warning { color: orange; }
.badge.low-stock { color: darkorange; }

.stock-buttons { display: inline-flex; gap: 4px; margin-left: 6px; }
.stock-btn { padding: 2px 6px; font-size: 0.8em; }
.stock-input { width: 45px; padding: 2px; }

.modifica-btn, .elimina-btn {
  padding: 6px 10px;
  border-radius: 8px;
  font-weight: bold;
  color: white;
}
.modifica-btn { background: #f4a300; }
.elimina-btn { background: #d9534f; }

.modifica-btn:hover { background: #ffb700; }
.elimina-btn:hover { background: #c9302c; }

.info-popup {
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border-radius: 12px;
  padding: 20px;
  width: 300px;
  text-align: center;
  box-shadow: 0 0 12px rgba(0,0,0,0.3);
  display: none;
  z-index: 9999;
}

.no-results { text-align: center; color: red; font-weight: bold; }
</style>

<script>
function mostraInfo(codice, sostituto) {
  document.getElementById("infoContent").innerHTML =
    "Il ricambio <b>" + codice + "</b> √® sostituibile con <b>" + sostituto + "</b>.";
  document.getElementById("infoBox").style.display = "block";
}
function chiudiInfo() {
  document.getElementById("infoBox").style.display = "none";
}

// Scroll restore
window.addEventListener("beforeunload", () => {
  localStorage.setItem("scroll_ricambi", window.scrollY)
});
window.addEventListener("load", () => {
  const pos = localStorage.getItem("scroll_ricambi");
  if (pos !== null) window.scrollTo(0, parseInt(pos));
});
</script>

{% endblock %}
