{% extends "base.html" %}

{% block title %}Giacenza Magazzino{% endblock %}

{% block content %}
<style>
    .metal-box {
        background: linear-gradient(180deg, #f5f5f5, #c0c0c0, #e0e0e0);
        border: 3px solid #000;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }

    h1 {
        color: #111;
        text-transform: uppercase;
        font-weight: bold;
        border-bottom: 3px solid #7a0000;
        padding-bottom: 6px;
        margin-bottom: 25px;
    }

    /* FILTRI */
    .filter-box {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background: linear-gradient(90deg, #7a0000, #c00000);
        border: 2px solid black;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        flex-wrap: wrap;
    }

    .filter-item {
        flex: 1;
        min-width: 180px;
        position: relative;
    }

    .filter-item input {
        width: 100%;
        padding: 8px;
        border: 2px solid #000;
        border-radius: 6px;
        margin-bottom: 3px;
        background: #f5f5f5;
    }

    .filter-select {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        border: 2px solid #000;
        background: linear-gradient(180deg, #cfcfcf, #e6e6e6);
        font-weight: bold;
    }

    .filter-label {
        font-weight: bold;
        color: white;
        margin-bottom: 3px;
        display: block;
    }

    #resetFiltri {
        background:black;
        color:white;
        padding:10px 15px;
        border:2px solid #fff;
        border-radius:8px;
        font-weight:bold;
        cursor:pointer;
        box-shadow:0 2px 5px rgba(0,0,0,0.4);
        margin-top:22px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th {
        background: linear-gradient(90deg, #7a0000, #e00000, #7a0000);
        color: white;
        padding: 12px;
        text-align: center;
        font-size: 15px;
        border: 2px solid black;
    }

    td {
        background: linear-gradient(90deg, #e6e6e6, #f7f7f7, #e6e6e6);
        padding: 10px;
        border: 1px solid #999;
        text-align: center;
    }

    tr:nth-child(even) td {
        background: linear-gradient(90deg, #cdcdcd, #e5e5e5, #cdcdcd);
    }

    .bollino {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: inline-block;
        border: 2px solid #000;
    }

    .inviato { background-color: #1e90ff; }
    .arrivato { background-color: #ffd700; }
    .appuntamento { background-color: #32cd32; }
    .stock {
        background: linear-gradient(90deg, #a8a8a8, #e0e0e0);
    }

    .btn-stato {
        display: block;
        margin: 4px 0;
        padding: 6px;
        border-radius: 8px;
        border: 2px solid #000;
        font-weight: bold;
        cursor: pointer;
        text-decoration: none;
        transition: 0.2s;
    }

    .btn-arrivato { background-color: #ffd700; }
    .btn-app { background-color: #32cd32; color: white; }
    .btn-stock { background: linear-gradient(90deg, #a8a8a8, #e0e0e0); }

    .btn-elimina {
        margin-top: 8px;
        background: #222;
        color: white;
        border: 2px solid #000;
        padding: 6px;
        border-radius: 8px;
        text-decoration: none;
        display: inline-block;
    }
</style>

<div class="metal-box">
    <h1>üèéÔ∏è Giacenza Magazzino</h1>

    {% if ordini|length == 0 %}
        <p>Nessun ordine presente in magazzino.</p>
    {% else %}

    <!-- üî• FILTRI -->
    <div class="filter-box">

        <!-- PRODOTTO -->
        <div class="filter-item">
            <label class="filter-label">Prodotto</label>
            <input type="text" id="filterProdotto">
            <select class="filter-select" id="selectProdotto">
                <option value="">Tutti</option>
                {% for prodotto in ordini|map(attribute='prodotto')|unique %}
                    <option value="{{ prodotto }}">{{ prodotto }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- CODICE -->
        <div class="filter-item">
            <label class="filter-label">Codice</label>
            <input type="text" id="filterCodice">
            <select class="filter-select" id="selectCodice">
                <option value="">Tutti</option>
                {% for codice in ordini|map(attribute='codice')|unique %}
                    {% if codice %}
                        <option value="{{ codice }}">{{ codice }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

        <!-- TARGA -->
        <div class="filter-item">
            <label class="filter-label">Targa</label>
            <input type="text" id="filterTarga">
            <select class="filter-select" id="selectTarga">
                <option value="">Tutte</option>
                {% for targa in ordini|map(attribute='targa')|unique %}
                    <option value="{{ targa }}">{{ targa }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- CLIENTE -->
        <div class="filter-item">
            <label class="filter-label">Cliente</label>
            <input type="text" id="filterCliente">
            <select class="filter-select" id="selectCliente">
                <option value="">Tutti</option>
                {% for cliente in ordini|map(attribute='cliente')|unique %}
                    <option value="{{ cliente }}">{{ cliente }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- üëâ NUOVO: FORNITORE -->
        <div class="filter-item">
            <label class="filter-label">Fornitore</label>
            <input type="text" id="filterFornitore">
            <select class="filter-select" id="selectFornitore">
                <option value="">Tutti</option>
                {% for f in ordini|map(attribute='fornitore')|unique %}
                    {% if f %}
                        <option value="{{ f }}">{{ f }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

        <!-- RESET -->
        <div>
            <button id="resetFiltri">Reset Filtri</button>
        </div>

    </div>

    <!-- üî• TABELLA -->
    <table id="tabellaOrdini">
        <thead>
            <tr>
                <th>Prodotto</th>
                <th>Codice</th>
                <th>Targa</th>
                <th>Cliente</th>
                <th>Inserito il</th>
                <th>Fornitore</th>
                <th>Stato</th>
                <th>Bollino</th>
                <th>Cambia Stato</th>
                <th>Elimina</th>
            </tr>
        </thead>

        <tbody>
            {% for ordine in ordini %}
            <tr>
                <td class="col-prodotto">{{ ordine.prodotto }}</td>
                <td class="col-codice">{{ ordine.codice or "-" }}</td>
                <td class="col-targa">{{ ordine.targa }}</td>
                <td class="col-cliente">{{ ordine.cliente }}</td>

                <td>
                    {% if ordine.data_creazione %}
                        {{ ordine.data_creazione.strftime('%d/%m/%Y %H:%M') }}
                    {% else %}
                        -
                    {% endif %}
                </td>

                <td class="col-fornitore">{{ ordine.fornitore or "-" }}</td>

                <td>{{ ordine.stato }}</td>

                <td>
                    {% if ordine.stato == "Ordine Inviato" %}
                        <span class="bollino inviato"></span>
                    {% elif ordine.stato == "Ordine Arrivato" %}
                        <span class="bollino arrivato"></span>
                    {% elif ordine.stato == "Appuntamento Fissato" %}
                        <span class="bollino appuntamento"></span>
                    {% else %}
                        <span class="bollino stock"></span>
                    {% endif %}
                </td>

                <td style="width:160px;">
                    {% if ordine.stato == "Ordine Inviato" %}
                        <a class="btn-stato btn-arrivato"
                           href="{{ url_for('cambia_stato_ordine', id=ordine.id, nuovo_stato='Ordine Arrivato') }}">
                           Arrivato
                        </a>
                        <a class="btn-stato btn-app"
                           href="{{ url_for('cambia_stato_ordine', id=ordine.id, nuovo_stato='Appuntamento Fissato') }}">
                           Appuntamento
                        </a>
                        <a class="btn-stato btn-stock"
                           href="{{ url_for('cambia_stato_ordine', id=ordine.id, nuovo_stato='In Stock') }}">
                           In Stock
                        </a>
                    {% endif %}

                    {% if ordine.stato == "Ordine Arrivato" %}
                        <a class="btn-stato btn-app"
                           href="{{ url_for('cambia_stato_ordine', id=ordine.id, nuovo_stato='Appuntamento Fissato') }}">
                           Appuntamento
                        </a>
                        <a class="btn-stato btn-stock"
                           href="{{ url_for('cambia_stato_ordine', id=ordine.id, nuovo_stato='In Stock') }}">
                           In Stock
                        </a>
                    {% endif %}

                    {% if ordine.stato in ["Appuntamento Fissato", "In Stock"] %}
                        <span style="font-size:13px; font-weight:bold; color:#444;">Stato Definitivo</span>
                    {% endif %}
                </td>

                <td>
                    <a class="btn-elimina"
                       onclick="return confirm('Eliminare definitivamente?')"
                       href="{{ url_for('elimina_ordine', id=ordine.id) }}">
                       X
                    </a>
                </td>

            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% endif %}
</div>

<!-- üî• JS FILTRI -->
<script>
function applyFilters() {
    let fProd = document.getElementById("filterProdotto").value.toLowerCase();
    let fCod = document.getElementById("filterCodice").value.toLowerCase();
    let fTar = document.getElementById("filterTarga").value.toLowerCase();
    let fCli = document.getElementById("filterCliente").value.toLowerCase();
    let fFor = document.getElementById("filterFornitore").value.toLowerCase();

    let selProd = document.getElementById("selectProdotto").value.toLowerCase();
    let selCod  = document.getElementById("selectCodice").value.toLowerCase();
    let selTar  = document.getElementById("selectTarga").value.toLowerCase();
    let selCli  = document.getElementById("selectCliente").value.toLowerCase();
    let selFor  = document.getElementById("selectFornitore").value.toLowerCase();

    document.querySelectorAll("#tabellaOrdini tbody tr").forEach(row => {
        let p = row.querySelector(".col-prodotto").textContent.toLowerCase();
        let c = row.querySelector(".col-codice").textContent.toLowerCase();
        let t = row.querySelector(".col-targa").textContent.toLowerCase();
        let cl = row.querySelector(".col-cliente").textContent.toLowerCase();
        let fr = row.querySelector(".col-fornitore").textContent.toLowerCase();

        let show = true;

        if (fProd && !p.includes(fProd)) show = false;
        if (fCod && !c.includes(fCod)) show = false;
        if (fTar && !t.includes(fTar)) show = false;
        if (fCli && !cl.includes(fCli)) show = false;
        if (fFor && !fr.includes(fFor)) show = false;

        if (selProd && p !== selProd) show = false;
        if (selCod && c !== selCod) show = false;
        if (selTar && t !== selTar) show = false;
        if (selCli && cl !== selCli) show = false;
        if (selFor && fr !== selFor) show = false;

        row.style.display = show ? "" : "none";
    });
}

document.querySelectorAll("input[id^='filter'], select[id^='select']")
    .forEach(el => el.addEventListener("input", applyFilters));

document.getElementById("resetFiltri").addEventListener("click", () => {
    document.querySelectorAll(".filter-item input").forEach(e => e.value = "");
    document.querySelectorAll(".filter-item select").forEach(e => e.value = "");
    document.querySelectorAll("#tabellaOrdini tbody tr").forEach(r => r.style.display = "");
});
</script>

{% endblock %}
