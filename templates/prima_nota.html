{% extends "base.html" %}
{% block title %}Prima Nota{% endblock %}

{% block content %}

<h1>ğŸ§¾ Prima Nota Giornaliera</h1>

<div style="display:flex; gap:15px; margin-bottom:20px;">
    <a href="/prima_nota/storico">
        <button>ğŸ“… Storico Prima Nota</button>
    </a>
</div>

<label>Data</label>
<input type="date" id="data">

<label>Descrizione</label>
<input type="text" id="descrizione">

<div class="grid-2">
    <div>
        <label>Banca / POS / Carta</label>
        <input type="number" id="banca" step="0.01">
    </div>
    <div>
        <label>Cassa (contanti)</label>
        <input type="number" id="cassa" step="0.01">
    </div>
</div>

<label>Note</label>
<textarea id="note" rows="3"></textarea>

<button id="btn-aggiungi">â• Aggiungi Movimento</button>
<button id="btn-chiudi-giornata" style="background:#dc3545;">
    ğŸ”’ Chiudi giornata
</button>

<hr>

<div class="grid-2">
    <div>
        <label>Saldo Cassa</label>
        <input type="number" id="saldo_cassa" readonly>
    </div>
    <div>
        <label>Totale Generale</label>
        <input type="number" id="totale_generale" readonly>
    </div>
</div>

<table id="tabella-container">
    <thead>
        <tr>
            <th>Data</th>
            <th>Descrizione</th>
            <th>Tipo</th>
            <th>Importo</th>
            <th>Saldo Cassa</th>
            <th>Totale</th>
            <th>Azioni</th>
        </tr>
    </thead>
    <tbody id="tabella-prima-nota"></tbody>
</table>

<!-- âœ… TASTO STAMPA RIPRISTINATO -->
<a id="btn-stampa" target="_blank">
    <button>ğŸ–¨ï¸ Stampa giornata</button>
</a>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const tbody = document.getElementById("tabella-prima-nota");
    const saldoCassaEl = document.getElementById("saldo_cassa");
    const totaleEl = document.getElementById("totale_generale");
    const dataInput = document.getElementById("data");
    const btnStampa = document.getElementById("btn-stampa");

    const descrizioneEl = document.getElementById("descrizione");
    const bancaEl = document.getElementById("banca");
    const cassaEl = document.getElementById("cassa");

    if (!dataInput.value) {
        dataInput.value = new Date().toISOString().split("T")[0];
    }

    function n(v){ return parseFloat(v) || 0; }
    function eur(v){ return n(v).toFixed(2); }

    function formatDataIt(dataStr) {
        const d = new Date(dataStr);
        const s = d.toLocaleDateString("it-IT", {
            weekday: "long",
            day: "2-digit",
            month: "2-digit",
            year: "numeric"
        });
        return s.charAt(0).toUpperCase() + s.slice(1);
    }

    function aggiornaLinkStampa() {
        btnStampa.href = `/prima_nota/stampa?data=${dataInput.value}`;
    }

    async function caricaMovimenti() {
        const res = await fetch(`/prima_nota/list?data=${dataInput.value}`, {
            credentials: "same-origin"
        });
        const rows = await res.json();

        let saldo = 0;
        let totale = 0;
        tbody.innerHTML = "";

        rows.forEach(r => {
            const isCassa = n(r.cassa) !== 0;
            const importo = isCassa ? n(r.cassa) : n(r.banca);

            totale += importo;
            if (isCassa) saldo += importo;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${formatDataIt(r.data)}</td>
                <td>${r.descrizione}</td>
                <td>${isCassa ? "Cassa" : "Banca"}</td>
                <td>${eur(importo)}</td>
                <td>${eur(saldo)}</td>
                <td>${eur(totale)}</td>
                <td><button class="del">ğŸ—‘ï¸</button></td>
            `;

            tr.querySelector(".del").onclick = async () => {
                await fetch(`/prima_nota/delete/${r.id}`, {
                    method: "POST",
                    credentials: "same-origin"
                });
                caricaMovimenti();
            };

            tbody.appendChild(tr);
        });

        saldoCassaEl.value = eur(saldo);
        totaleEl.value = eur(totale);
        aggiornaLinkStampa();
    }

    async function aggiungiMovimento() {
        const banca = n(bancaEl.value);
        const cassa = n(cassaEl.value);

        if (!descrizioneEl.value.trim() || (banca === 0 && cassa === 0)) {
            return;
        }

        const res = await fetch("/prima_nota/add", {
            method: "POST",
            credentials: "same-origin",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                data: dataInput.value,
                descrizione: descrizioneEl.value,
                banca: banca,
                cassa: cassa,
                note: document.getElementById("note").value
            })
        });

        const j = await res.json();
        if (!res.ok || !j.success) {
            alert(j.error || "Errore inserimento");
            return;
        }

        descrizioneEl.value = "";
        bancaEl.value = "";
        cassaEl.value = "";
        document.getElementById("note").value = "";

        caricaMovimenti();
        descrizioneEl.focus();
    }

    document.getElementById("btn-aggiungi").onclick = aggiungiMovimento;

    [descrizioneEl, bancaEl, cassaEl].forEach(el => {
        el.addEventListener("keydown", e => {
            if (e.key === "Enter") {
                e.preventDefault();
                aggiungiMovimento();
            }
        });
    });

    document.getElementById("btn-chiudi-giornata").onclick = async () => {
        await fetch("/prima_nota/chiudi", {
            method: "POST",
            credentials: "same-origin"
        });
        caricaMovimenti();
    };

    dataInput.addEventListener("change", caricaMovimenti);

    caricaMovimenti();
});
</script>

{% endblock %}
