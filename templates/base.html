<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}Gestione Concessionaria{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background-color: #004080; color: #333; }
        header { background-color: #004080; padding: 30px 0 20px 0; text-align: center; }
        header img { height: 160px; width: auto; cursor: pointer; }
        nav { background-color: #003366; display: flex; justify-content: center; gap: 20px; padding: 12px 0; flex-wrap: wrap; }
        nav a { color: white; text-decoration: none; font-weight: bold; padding: 8px 16px; border-radius: 6px; transition: background-color 0.3s; }
        nav a:hover { background-color: #0052A3; }
        main { background-color: #ffffff; max-width: 1200px; margin: 30px auto; padding: 40px 50px; border-radius: 20px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25); }
        h1 { text-align: center; color: #004080; margin-bottom: 30px; font-size: 2em; }
        a.button { display: inline-block; padding: 12px 20px; margin: 20px 0; background-color: #0052A3; color: white; text-decoration: none; border-radius: 6px; font-weight: bold; transition: background-color 0.3s; }
        a.button:hover { background-color: #003f7f; }
        button { background-color: #0052A3; color: white; padding: 12px 20px; border: none; cursor: pointer; border-radius: 6px; margin-top: 16px; }
        button:hover { background-color: #003f7f; }
        input, select, textarea { padding: 10px; width: 100%; margin: 12px 0; border: 1px solid #ccc; border-radius: 5px; font-size: 1em; }

        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #ccc; }
        th { background-color: #0052A3; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .empty-message { text-align: center; padding: 20px; font-size: 1.2em; color: #666; }

        .model-actions-shape { display: flex; gap: 10px; flex-wrap: wrap; }
        .shape-btn { padding: 10px 16px; font-weight: bold; border-radius: 14px; border: none; cursor: pointer; font-size: 1.1em; min-width: 50px; transition: transform 0.2s, box-shadow 0.2s; text-align: center; color: white; box-shadow: 0 3px 8px rgba(0,0,0,0.25); }
        .shape-modifica { background-color: #FFA500; }
        .shape-modifica:hover { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .shape-elimina { background-color: #dc3545; }
        .shape-elimina:hover { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        @media screen and (max-width:768px){
            .shape-btn { min-width: 40px; padding: 8px 12px; font-size:1em; }
            main { padding: 20px; }
            header img { height: 100px; }
            nav { flex-direction: column; gap: 10px; }
            table, th, td { font-size: 0.9em; }
        }

        .flash-message { margin-bottom: 10px; }

        /* QUADRATI (stile base) */
        #quadrato-lavorazioni {
            position: fixed; top: 100px; left: 20px; width: 60px; height: 60px; border-radius: 12px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 2100; transition: transform 0.2s; -webkit-tap-highlight-color: transparent; pointer-events: auto; background-color: #fff3cd;
        }
        #quadrato-lavorazioni:hover { transform: scale(1.1); }

        /* POPUP LAVORAZIONI */
        #popup-lavorazioni {
            position: fixed; top: 250px; left: 20px; width: 350px; max-height: 500px;
            background-color: #fff; border-radius: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.3); padding: 20px; overflow-y: auto; display: none; z-index: 2000;
        }
        #popup-lavorazioni h3 { margin-top: 0; color: #004080; text-align: center; }
        #popup-lavorazioni ul { list-style: none; padding-left: 0; max-height: 400px; overflow-y: auto; }

        .lavorazione { padding: 8px; margin-bottom: 6px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; display:flex; justify-content:space-between; align-items:center; }
        .lavorazione.ordine_inviato { background-color: #fff3cd; }
        .lavorazione.in_lavorazione { background-color: #cce5ff; }
        .lavorazione.attesa_del_levabolle { background-color: #b0b0b0; color:#000; } /* grigio metallizzato */
        .lavorazione.completata { background-color: #c8f7c5; }
        .lavorazione button { margin-left: 5px; padding: 4px 8px; font-size:0.85em; border-radius:6px; border:none; cursor:pointer; font-weight:bold; }

        /* STORICO */
        #btn-storico { position: fixed; bottom: 25px; right: 25px; width: 65px; height: 65px; border-radius: 50%; background-color: #ffc107; color: #000; font-size: 28px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); z-index: 1200; transition: transform 0.2s, background-color 0.3s; }
        #btn-storico:hover { transform: scale(1.1); background-color: #ffcd39; }
        #popup-storico { position: fixed; bottom: 100px; right: 25px; width: 350px; max-height: 450px; background-color: #fff; border-radius: 16px; box-shadow: none; padding: 20px; overflow-y: auto; display: none; z-index: 1201; }
    </style>
</head>
<body>
<header>
    {% if session.get('ruolo') == 'accettazione' %}<a href="{{ url_for('home') }}">
    {% elif session.get('ruolo') == 'officina' %}<a href="{{ url_for('home_officina') }}">
    {% elif session.get('ruolo') == 'officina_gomme' %}<a href="{{ url_for('home_officina_gomme') }}">
    {% else %}<a href="{{ url_for('scelta_login') }}">
    {% endif %}
        <img src="{{ url_for('static', filename='logo.26861.png') }}" alt="Logo Gruppo AutoscalA">
    </a>
</header>

<nav>
    {% if session.get('username') %}
        {% if session.get('ruolo') == 'accettazione' %}
            <a href="{{ url_for('lista_clienti') }}">üë• Clienti</a>
            <a href="{{ url_for('inserisci_cliente') }}">‚ûï Inserisci Cliente</a>
            <a href="{{ url_for('lista_vetture') }}">üöó Vetture</a>
            <a href="{{ url_for('inserisci_vettura') }}">‚ûï Inserisci Vettura</a>
            <a href="{{ url_for('lista_modelli') }}">üõ†Ô∏è Modelli</a>
            <a href="{{ url_for('lista_ricambi') }}">üîß Ricambi</a>
            <a href="{{ url_for('giacenza_gomme') }}" title="Giacenza Gomme">üõû Giacenza Gomme</a>
        {% endif %}
        <a href="{{ url_for('logout') }}">üîí Logout ({{ session['username'] }})</a>
    {% else %}
        <a href="{{ url_for('scelta_login') }}">üîë Login</a>
    {% endif %}
</nav>

{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div id="flash-container" style="text-align:center; margin:20px 0;">
      {% for message in messages %}
        <p class="flash-message" style="background-color:#d4edda; color:#155724; padding:12px 20px; border-radius:6px; display:inline-block;">
          {{ message }}
        </p>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<main>
    {% block content %}
    {% if clienti|default([])|length == 0 %}
        <div class="empty-message">Nessun cliente trovato.</div>
    {% endif %}
    {% if vetture|default([])|length == 0 %}
        <div class="empty-message">Nessuna vettura trovata.</div>
    {% endif %}
{% endblock %}
</main>

{% if session.get('username') and session.get('ruolo') == 'accettazione' %}
<div id="quadrato-lavorazioni" role="button" aria-label="Lavorazioni" tabindex="0">üìÅ</div>
<div id="popup-lavorazioni">
    <h3>Lavorazioni Recenti</h3>
    <ul id="lista-lavorazioni"></ul>
</div>

{% include 'promemoria_widget.html' %}
{% include 'ordini_widget.html' %}
{% include 'magazzino_widget.html' %}
{% include 'prima_nota_widget.html' %}


<button id="btn-storico">üïí</button>
<div id="popup-storico">
    <h3>Storico Operazioni</h3>
    <ul id="storico-list"></ul>
</div>

<div id="popup-dettagli" style="display:none;
     position: fixed; top: 50%; left: 50%;
     transform: translate(-50%, -50%);
     background: white; padding: 25px; border-radius: 12px;
     box-shadow: 0 6px 20px rgba(0,0,0,0.3);
     width: 400px; max-height: 500px; overflow-y: auto; z-index: 2000;">
  <h3>Dettagli lavorazione</h3>
  <ul id="dettagli-list"></ul>
  <button id="chiudi-dettagli"
          style="margin-top: 10px; background-color:#0052A3; color:white;
                 border:none; padding:10px 15px; border-radius:6px; cursor:pointer;">
    Chiudi
  </button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    function escapeHtmlText(s){ return String(s||'').replace(/[&<>"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

    const quadLav = document.getElementById('quadrato-lavorazioni');
    const popupLav = document.getElementById('popup-lavorazioni');
    const listaLav = document.getElementById('lista-lavorazioni');
    const popupDettagli = document.getElementById('popup-dettagli');
    const dettagliList = document.getElementById('dettagli-list');
    const chiudiDettagli = document.getElementById('chiudi-dettagli');

    if (quadLav && popupLav && listaLav) {
        const toggleLav = async ()=> {
            popupLav.style.display = (popupLav.style.display === 'block') ? 'none' : 'block';
            if (popupLav.style.display === 'block') await refreshLavorazioni();
        };
        quadLav.addEventListener('click', toggleLav);
        quadLav.addEventListener('keydown', (ev)=> { if(ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); toggleLav(); } });
    }

    async function refreshLavorazioni(){
        if(!listaLav) return;
        listaLav.innerHTML = '<li>Caricamento...</li>';
        try{
            const res = await fetch('{{ url_for("ajax_lavorazioni") }}');
            const data = await res.json();
            listaLav.innerHTML='';
            if(!data || data.length===0){
                listaLav.innerHTML='<li>Nessuna lavorazione</li>';
                return;
            }
            data.forEach(item=>{
                const li = document.createElement('li');
                li.classList.add('lavorazione');
                li.dataset.id = item.id;

                // normalizzazione stato per CSS e logica pulsanti
                let statoNorm = (item.stato || '').toLowerCase().replace(/ /g,'_');
                li.classList.remove('ordine_inviato','in_lavorazione','attesa_levabolle','completata','attesa_del_levabolle');
                li.classList.add(statoNorm);

                const displayDate = item.data_creazione || '';
                const marca = item.marca || '';
                const modello = item.modello || '';
                const stato = item.stato || '';

                // nasconde i pulsanti correttamente per stati bloccati
                const hidePresa = ['in_lavorazione','completata','attesa_del_levabolle'].includes(statoNorm) ? 'display:none;' : '';
                const hideCompletata = ['completata','attesa_del_levabolle'].includes(statoNorm) ? 'display:none;' : '';

                li.innerHTML = `<span>[${displayDate}] ${marca} ${modello} - ${stato}</span>
                    <span>
                        <button class="btn-presa" style="${hidePresa}">‚û°Ô∏è</button>
                        <button class="btn-completata" style="${hideCompletata}">‚úîÔ∏è</button>
                        <button class="btn-modifica">‚úèÔ∏è</button>
                        <button class="btn-elimina">üóëÔ∏è</button>
                    </span>`;

                li.querySelector('.btn-presa')?.addEventListener('click', async e=>{
                    e.stopPropagation();
                    await aggiornaStato(item.id,'in_lavorazione');
                });
                li.querySelector('.btn-completata')?.addEventListener('click', async e=>{
                    e.stopPropagation();
                    await aggiornaStato(item.id,'completata');
                });
                li.querySelector('.btn-elimina')?.addEventListener('click', async e=>{
                    e.stopPropagation();
                    if(confirm('Eliminare lavorazione?')) await eliminaLavorazione(item.id);
                });
                li.querySelector('.btn-modifica')?.addEventListener('click', async e=>{
                    e.stopPropagation();
                    openLavorazioneDetail(item,true);
                });

                li.addEventListener('click', e=>{
                    if(e.target && (e.target.tagName.toLowerCase()==='button'||e.target.closest('button'))) return;
                    openLavorazioneDetail(item,false);
                });

                listaLav.appendChild(li);
            });
        }catch(err){ console.error(err); if(listaLav) listaLav.innerHTML='<li>Errore caricamento</li>'; }
    }

    async function aggiornaStato(id, stato){
        try{
            const res = await fetch(`/accettazione/aggiorna_stato/${id}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({stato})});
            const data = await res.json();
            if(data && data.success) refreshLavorazioni();
            else { if(!data || data.success===false) alert('Errore aggiornamento stato'); else refreshLavorazioni(); }
        }catch(err){ console.error(err); alert('Errore comunicazione'); }
    }

    async function eliminaLavorazione(id){
        try{
            const res = await fetch(`/accettazione/elimina_lavorazione/${id}`, {method:'POST'});
            const data = await res.json();
            if(data && data.success) refreshLavorazioni();
            else alert('Errore eliminazione');
        }catch(err){ console.error(err); alert('Errore eliminazione'); }
    }

    function openLavorazioneDetail(item, editable=false){
        if(!popupDettagli || !dettagliList) return;
        dettagliList.innerHTML = '';
        const rows = [];
        function inputOrText(val,key){ return editable ? `<input type="text" value="${escapeHtmlText(val||'')}" data-key="${key}">` : escapeHtmlText(val||''); }

        rows.push(`<li><strong>N¬∞ Ordine:</strong> ${inputOrText(item.ordine_riparazione,'ordine_riparazione')}</li>`);
        rows.push(`<li><strong>Tipo:</strong> ${inputOrText(item.tipo,'tipo')}</li>`);
        rows.push(`<li><strong>Marca:</strong> ${inputOrText(item.marca,'marca')}</li>`);
        rows.push(`<li><strong>Modello:</strong> ${inputOrText(item.modello,'modello')}</li>`);
        rows.push(`<li><strong>Cilindrata:</strong> ${inputOrText(item.cilindrata,'cilindrata')}</li>`);
        rows.push(`<li><strong>KW:</strong> ${inputOrText(item.kw,'kw')}</li>`);
        rows.push(`<li><strong>Anno:</strong> ${inputOrText(item.anno,'anno')}</li>`);
        rows.push(`<li><strong>Nome cliente:</strong> ${inputOrText(item.cliente_nome,'cliente_nome')}</li>`);
        rows.push(`<li><strong>Cognome cliente:</strong> ${inputOrText(item.cognome_cliente,'cognome_cliente')}</li>`);
        rows.push(`<li><strong>Targa:</strong> ${inputOrText(item.targa,'targa')}</li>`);
        rows.push(`<li><strong>Descrizione:</strong> ${inputOrText(item.descrizione,'descrizione')}</li>`);
        rows.push(`<li><strong>Note:</strong> ${inputOrText(item.note,'note')}</li>`);
        if(item.dettagli) rows.push(`<li><strong>Dettagli:</strong> ${inputOrText(item.dettagli,'dettagli')}</li>`);
        rows.push(`<li><strong>Stato:</strong> ${escapeHtmlText(item.stato || '')}</li>`);
        rows.push(`<li><strong>Data Creazione:</strong> ${escapeHtmlText(item.data_creazione || '')}</li>`);

        if(editable) rows.push(`<li><button id="btn-salva-lavorazione" style="margin-top:10px;background-color:#28a745;color:white;border:none;padding:10px 15px;border-radius:6px;cursor:pointer;">üíæ Salva</button></li>`);

        dettagliList.innerHTML = rows.join('');
        popupDettagli.style.display = 'block';

        if(editable){
            document.getElementById('btn-salva-lavorazione')?.addEventListener('click', async ()=>{
                const inputs = dettagliList.querySelectorAll('input');
                const payload = {};
                inputs.forEach(inp=>{ payload[inp.dataset.key] = inp.value; });
                try{
                    const res = await fetch(`/accettazione/modifica_lavorazione/${item.id}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
                    const data = await res.json();
                    if(data && data.success){
                        alert('Modifiche salvate');
                        popupDettagli.style.display='none';
                        refreshLavorazioni();
                    } else alert('Errore salvataggio');
                }catch(err){ console.error(err); alert('Errore comunicazione'); }
            });
        }
    }

    if (chiudiDettagli) {
        chiudiDettagli.addEventListener('click', ()=> {
            if(popupDettagli) popupDettagli.style.display = 'none';
            if(dettagliList) dettagliList.innerHTML = '';
        });
    }

    // --- STORICO ---
    const btnStorico = document.getElementById('btn-storico');
    const popupStorico = document.getElementById('popup-storico');
    const listaStorico = document.getElementById('storico-list');

    if (btnStorico && popupStorico && listaStorico) {
        btnStorico.addEventListener('click', async ()=> {
            popupStorico.style.display = (popupStorico.style.display==='block') ? 'none' : 'block';
            if(popupStorico.style.display==='block'){
                listaStorico.innerHTML = '<li>Caricamento...</li>';
                try{
                    const res = await fetch('{{ url_for("storico") }}?ajax=1');
                    const data = await res.json();
                    listaStorico.innerHTML = '';
                    if(!data || data.length===0){ listaStorico.innerHTML='<li>Nessuna operazione</li>'; return; }
                    data.forEach(item=>{
                        const dataOra = item.data_ora || item.data || item.data_creazione || item.data_attivita || '';
                        const username = item.username || item.utente || 'Sistema';
                        const tabella = item.tabella_nome || item.tabella || '';
                        const azione = item.azione || item.operazione || item.azione_descrizione || '';
                        const li = document.createElement('li');
                        li.textContent = `[${dataOra}] ${username} ‚Üí ${tabella} (${azione})`;
                        listaStorico.appendChild(li);
                    });
                }catch(err){ console.error(err); listaStorico.innerHTML='<li>Errore caricamento</li>'; }
            }
        });
    }

});
</script>

<script src="{{ url_for('static', filename='promemoria.js') }}"></script>

{% endif %}
</body>
</html>
