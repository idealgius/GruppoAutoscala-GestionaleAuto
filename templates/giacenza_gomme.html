{% extends "base.html" %}

{% block title %}Giacenza Gomme{% endblock %}

{% block content %}
<h1 style="text-align:center; color:#004080; margin-bottom:30px; font-weight:700; font-family:'Segoe UI', Tahoma, sans-serif;">üì¶ Giacenza Gomme</h1>

{% set solo_lettura = session.get('ruolo') == 'accettazione' %}

{% if gomme %}

<!-- BARRA STAMPA PROFESSIONALE (NUOVA, VISIBILE) -->
<div style="max-width:900px; margin:0 auto 20px auto; display:flex; justify-content:flex-end; align-items:center; gap:10px;">
    <button id="select-all-print" class="btn btn-sm btn-outline-primary">‚úî Seleziona tutte</button>
    <button id="deselect-all-print" class="btn btn-sm btn-outline-secondary">‚úñ Deseleziona tutte</button>
    <button id="print-selected" class="btn btn-sm btn-success">üñ®Ô∏è Stampa giacenza</button>
</div>

<!-- FILTRI -->
<div style="max-width:900px; margin:0 auto 20px auto; display:flex; gap:12px; flex-wrap:wrap; justify-content:center; align-items:center;">

    <div class="select-wrapper">
        <select id="filtro-marca" class="form-select form-select-sm">
            <option value="">Tutte le marche</option>
            {% for m in gomme|map(attribute='marca')|unique|sort %}
                <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="select-wrapper">
        <select id="filtro-misura" class="form-select form-select-sm">
            <option value="">Tutte le misure</option>
            {% for g in gomme %}
                {% set misura = g.larghezza ~ '/' ~ g.rapporto ~ ' R' ~ g.diametro %}
                <option value="{{ misura }}">{{ misura }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div id="lista-gomme" style="max-width:900px; margin:0 auto; display:flex; flex-direction:column; gap:18px;">
    {% for g in gomme %}
    {% set misura = g.larghezza ~ '/' ~ g.rapporto ~ ' R' ~ g.diametro %}
    <div class="gomma-item"
         data-id="{{ g.id }}"
         data-marca="{{ g.marca }}"
         data-misura="{{ misura }}"
         style="padding:18px; border-radius:12px; background:#f9f9f9; box-shadow:0 4px 12px rgba(0,0,0,0.1); transition: all 0.25s ease-in-out;">

        <!-- NUOVA CHECKBOX PER STAMPA -->
        <div style="margin-bottom:8px;">
            <input type="checkbox" class="select-for-print">
            <span style="font-size:13px; color:#666;">Seleziona per stampa</span>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div style="flex:1;">
                <strong style="font-size:18px; color:#004080;">{{ g.marca }}</strong>
                <div style="font-size:16px; margin-bottom:8px; color:#333;">
                    {{ misura }}
                </div>

                <div style="margin-top:8px; font-size:14px;">
                    Prezzo unitario:
                    <input type="text" value="{{ g.prezzo_unitario }}"
                           class="prezzo-unitario"
                           style="width:75px; border-radius:4px; border:1px solid #ccc; padding:2px 4px;"
                           {% if solo_lettura %}readonly{% endif %}> ‚Ç¨

                    &nbsp;&nbsp;

                    Prezzo treno:
                    <input type="text" value="{{ g.prezzo_treno }}"
                           class="prezzo-treno"
                           style="width:75px; border-radius:4px; border:1px solid #ccc; padding:2px 4px;"
                           {% if solo_lettura %}readonly{% endif %}> ‚Ç¨
                </div>

                <div style="margin-top:10px; font-size:14px;">
                    Disponibilit√†:
                    <button class="dec-disponibilita btn-sm btn-secondary"
                            style="padding:3px 6px; margin-left:4px; margin-right:4px;"
                            {% if solo_lettura %}disabled{% endif %}>-</button>
                    <span class="quantita" style="font-weight:bold; font-size:15px;">{{ g.disponibilita }}</span>
                    <button class="inc-disponibilita btn-sm btn-secondary"
                            style="padding:3px 6px; margin-left:4px;"
                            {% if solo_lettura %}disabled{% endif %}>+</button>
                </div>

                <!-- NOTE -->
                <div style="margin-top:12px; font-size:14px;">
                    <label><strong>Note:</strong></label><br>
                    <div class="nota-gomma-box" style="background:#fff; border:1px solid #ccc; padding:8px; border-radius:6px; min-height:50px; position:relative;">
                        <span class="nota-gomma-text" style="color:#555;">{{ g.note or 'Nessuna nota' }}</span>
                        {% if not solo_lettura %}
                        <textarea class="nota-gomma" style="width:100%; display:none; resize:vertical; min-height:50px; border-radius:4px; border:1px solid #ccc;">{{ g.note or '' }}</textarea>
                        <button class="edit-nota" style="position:absolute; top:5px; right:5px; font-size:0.85em; padding:2px 6px; cursor:pointer; background:#007bff; color:white; border:none; border-radius:4px;">‚úè Modifica</button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div style="display:flex; flex-direction:column; align-items:flex-start;">
                {% if not solo_lettura %}
                <button class="save-gomma btn btn-success"
                        style="margin-bottom:8px; padding:6px 12px;">
                    üíæ Salva
                </button>

                <button class="delete-gomma btn btn-danger"
                        style="padding:6px 12px;">
                    ‚ùå Elimina
                </button>
                {% endif %}
            </div>
        </div>

    </div>
    {% endfor %}
</div>

{% else %}
<p style="text-align:center; color:#666;">Nessuna gomma inserita.</p>
{% endif %}

<!-- STILI CUSTOM SELECT -->
<style>
.select-wrapper select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background: #fff;
    cursor: pointer;
    border-radius: 6px;
    border:1px solid #ccc;
    padding:5px 8px;
    min-width:160px;
}
.select-wrapper select:focus {
    outline:none;
    border-color:#004080;
    box-shadow:0 0 5px rgba(0,64,128,0.4);
}
</style>

<script>
// üî• Normalizza le misure
function normalizzaMisura(str){ return str ? str.replace(/[^0-9]/g,"") : ""; }

// üî• Filtra la lista gomme
function filtraGomme(){
    const marca = document.getElementById("filtro-marca").value;
    const misura = document.getElementById("filtro-misura").value;
    const misuraNorm = normalizzaMisura(misura);
    document.querySelectorAll('.gomma-item').forEach(div=>{
        const matchMarca = !marca || div.dataset.marca === marca;
        const matchMisura = !misuraNorm || normalizzaMisura(div.dataset.misura).startsWith(misuraNorm);
        div.style.display = (matchMarca && matchMisura) ? 'block' : 'none';
    });
}

// =============================
// SELECT CON SEARCHBAR
// =============================
function makeSearchableSelect(selectId){
    const select = document.getElementById(selectId);
    const wrapper = select.parentElement;
    let panel = null;
    select.addEventListener("mousedown", e=>e.preventDefault());
    function closePanel(){ if(panel){panel.remove(); panel=null;} }
    function openPanel(){
        closePanel();
        panel = document.createElement("div");
        panel.className = "custom-select-panel";
        const input = document.createElement("input");
        input.type="text"; input.placeholder="Cerca..."; input.className="search-input";
        panel.appendChild(input);
        const options = Array.from(select.options).map(opt=>({text:opt.textContent,value:opt.value,norm:normalizzaMisura(opt.value)}));
        function render(term=""){
            panel.querySelectorAll(".opt-row").forEach(e=>e.remove());
            const termNorm = normalizzaMisura(term);
            options.filter(o=>!termNorm || o.norm.startsWith(termNorm)).sort((a,b)=>a.norm.localeCompare(b.norm)).forEach(o=>{
                const row = document.createElement("div");
                row.className="opt-row"; row.textContent=o.text;
                row.addEventListener("click",()=>{select.value=o.value; closePanel(); filtraGomme();});
                panel.appendChild(row);
            });
        }
        render("");
        input.addEventListener("input",()=>{render(input.value);});
        wrapper.appendChild(panel);
        input.focus();
        setTimeout(()=>{document.addEventListener("click",function handler(e){if(!wrapper.contains(e.target)){closePanel(); document.removeEventListener("click",handler);}},20);});
    }
    select.addEventListener("click", e=>{ e.stopPropagation(); panel ? closePanel() : openPanel(); });
}

makeSearchableSelect("filtro-marca");
makeSearchableSelect("filtro-misura");

// üî• FUNZIONI GOMME
{% if not solo_lettura %}
document.querySelectorAll('.gomma-item').forEach(div=>{
    const id=div.dataset.id;
    const qta=div.querySelector('.quantita');
    const prezzoUnit=div.querySelector('.prezzo-unitario');
    const prezzoTreno=div.querySelector('.prezzo-treno');
    const notaBox=div.querySelector('.nota-gomma-box');
    const notaText=notaBox.querySelector('.nota-gomma-text');
    const notaTextarea=notaBox.querySelector('.nota-gomma');
    const editBtn=notaBox.querySelector('.edit-nota');

    if(editBtn) editBtn.addEventListener('click',()=>{notaText.style.display='none'; notaTextarea.style.display='block'; notaTextarea.focus();});

    div.querySelector('.inc-disponibilita').addEventListener('click',()=>{qta.textContent=parseInt(qta.textContent)+1;});
    div.querySelector('.dec-disponibilita').addEventListener('click',()=>{if(parseInt(qta.textContent)>0) qta.textContent=parseInt(qta.textContent)-1;});

    div.querySelector('.save-gomma').addEventListener('click', async ()=>{
        const formData=new FormData();
        formData.append("prezzo_unitario",prezzoUnit.value.trim());
        formData.append("prezzo_treno",prezzoTreno.value.trim());
        formData.append("disponibilita",qta.textContent);
        formData.append("note",notaTextarea.value.trim());
        try{
            const res=await fetch(`/modifica_gomma/${id}`,{method:"POST",body:formData});
            if(res.ok){ alert("‚úî Gomma aggiornata correttamente."); notaText.textContent=notaTextarea.value.trim()||'Nessuna nota'; notaTextarea.style.display='none'; notaText.style.display='block';}
            else alert("‚ùå Errore durante l'aggiornamento.");
        }catch(e){alert("‚ùå Errore di comunicazione con il server.");}
    });

    div.querySelector('.delete-gomma').addEventListener('click', async ()=>{
        if(!confirm('Eliminare questa gomma?')) return;
        try{
            const res=await fetch(`/elimina_gomma/${id}`,{method:"POST"});
            if(res.ok){div.remove(); alert("üóëÔ∏è Gomma eliminata.");} else alert("‚ùå Errore durante l'eliminazione.");
        }catch(e){alert("‚ùå Errore di comunicazione con il server.");}
    });
});
{% endif %}

// üî• STAMPA PROFESSIONALE CLIENT-SIDE (NUOVA, NON TOCCA NIENTE)
document.getElementById('select-all-print').onclick = ()=>document.querySelectorAll('.select-for-print').forEach(c=>c.checked=true);
document.getElementById('deselect-all-print').onclick = ()=>document.querySelectorAll('.select-for-print').forEach(c=>c.checked=false);

document.getElementById('print-selected').onclick = ()=>{
    const selezionate = Array.from(document.querySelectorAll('.gomma-item'))
        .filter(g=>g.querySelector('.select-for-print').checked);

    if(selezionate.length===0){ alert('Seleziona almeno una gomma da stampare'); return; }

    let html = `<html><head><title>Giacenza Gomme</title>
    <style>
        body { font-family: Arial, sans-serif; margin:20px; }
        table { width:100%; border-collapse: collapse; margin-top:20px; }
        th, td { border:1px solid #000; padding:6px; text-align:left; font-size:12px; }
        th { background:#eee; }
    </style>
    </head><body>
    <h2>Giacenza Gomme</h2>
    <table>
        <tr><th>Marca</th><th>Misura</th><th>Disponibilit√†</th><th>Prezzo unitario</th><th>Prezzo treno</th><th>Note</th></tr>`;

    selezionate.forEach(g=>{
        const note = g.querySelector('.nota-gomma-text')?.innerText || '';
        html += `<tr>
            <td>${g.dataset.marca}</td>
            <td>${g.dataset.misura}</td>
            <td>${g.querySelector('.quantita').innerText}</td>
            <td>${g.querySelector('.prezzo-unitario')?.value || ''}</td>
            <td>${g.querySelector('.prezzo-treno')?.value || ''}</td>
            <td>${note}</td>
        </tr>`;
    });

    html += `</table></body></html>`;

    const w = window.open('');
    w.document.write(html);
    w.document.close();
    w.focus();
    w.print();
};
</script>

{% endblock %}
