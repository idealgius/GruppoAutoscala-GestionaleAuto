{% extends "base.html" %}

{% block title %}Giacenza Gomme{% endblock %}

{% block content %}
<h1 style="text-align:center; color:#004080; margin-bottom:30px;">üì¶ Giacenza Gomme</h1>

{% set solo_lettura = session.get('ruolo') == 'accettazione' %}

{% if gomme %}
    <!-- FILTRI -->
    <div style="max-width:900px; margin:0 auto 20px auto; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
        <select id="filtro-marca">
            <option value="">Tutte le marche</option>
            {% for m in gomme|map(attribute='marca')|unique|sort %}
                <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
        </select>

        <select id="filtro-misura">
            <option value="">Tutte le misure</option>
            {% for g in gomme %}
                {% set misura = g.larghezza ~ '/' ~ g.rapporto ~ 'R' ~ g.diametro %}
                <option value="{{ misura }}">{{ misura }}</option>
            {% endfor %}
        </select>
    </div>

    <div id="lista-gomme" style="max-width:900px; margin:0 auto; display:flex; flex-direction:column; gap:15px;">
        {% for g in gomme %}
        <div class="gomma-item" data-id="{{ g.id }}" data-marca="{{ g.marca }}" data-misura="{{ g.larghezza }}/{{ g.rapporto }}R{{ g.diametro }}"
             style="padding:12px 15px; border-radius:8px; background:#f2f2f2; box-shadow:0 2px 5px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center;">
            <div style="flex:1;">
                <strong>{{ g.marca }}</strong> - {{ g.larghezza }}/{{ g.rapporto }}R{{ g.diametro }} <br>

                Prezzo unitario: 
                <input type="text" value="{{ g.prezzo_unitario }}" class="prezzo-unitario" style="width:70px;"
                       {% if solo_lettura %}readonly{% endif %}> ‚Ç¨ - 

                Prezzo treno: 
                <input type="text" value="{{ g.prezzo_treno }}" class="prezzo-treno" style="width:70px;"
                       {% if solo_lettura %}readonly{% endif %}> ‚Ç¨ <br>

                Disponibilit√†: 
                <button class="dec-disponibilita" style="padding:2px 6px;" {% if solo_lettura %}disabled{% endif %}>-</button>
                <span class="quantita">{{ g.disponibilita }}</span>
                <button class="inc-disponibilita" style="padding:2px 6px;" {% if solo_lettura %}disabled{% endif %}>+</button>
            </div>
            <div>
                {% if not solo_lettura %}
                <button class="save-gomma" style="margin-left:10px; padding:5px 10px; background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer;">üíæ Salva</button>
                <button class="delete-gomma" style="margin-left:10px; padding:5px 10px; background:#dc3545; color:white; border:none; border-radius:5px; cursor:pointer;">‚ùå Elimina</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <p style="text-align:center; color:#666;">Nessuna gomma inserita.</p>
{% endif %}

<script>
// --- FILTRI ---
const filtroMarca = document.getElementById('filtro-marca');
const filtroMisura = document.getElementById('filtro-misura');
const listaGomme = document.getElementById('lista-gomme');

function filtraGomme(){
    const marca = filtroMarca.value;
    const misura = filtroMisura.value;

    document.querySelectorAll('.gomma-item').forEach(div=>{
        const matchMarca = !marca || div.dataset.marca === marca;
        const matchMisura = !misura || div.dataset.misura === misura;
        div.style.display = (matchMarca && matchMisura) ? 'flex' : 'none';
    });
}

if(filtroMarca) filtroMarca.addEventListener('change', filtraGomme);
if(filtroMisura) filtroMisura.addEventListener('change', filtraGomme);

// --- FUNZIONALIT√Ä SOLO SE NON SOLO_LETTURA ---
{% if not solo_lettura %}
document.querySelectorAll('.gomma-item').forEach(div => {
    const id = div.dataset.id;
    const quantitaSpan = div.querySelector('.quantita');
    const inputUnit = div.querySelector('.prezzo-unitario');
    const inputTreno = div.querySelector('.prezzo-treno');

    // Incrementa quantit√†
    div.querySelector('.inc-disponibilita').addEventListener('click', () => {
        let val = parseInt(quantitaSpan.textContent);
        quantitaSpan.textContent = val + 1;
    });

    // Decrementa quantit√†
    div.querySelector('.dec-disponibilita').addEventListener('click', () => {
        let val = parseInt(quantitaSpan.textContent);
        if(val > 0) quantitaSpan.textContent = val - 1;
    });

    // Salva modifiche tramite fetch al backend
    div.querySelector('.save-gomma').addEventListener('click', async () => {
        const formData = new FormData();
        formData.append("prezzo_unitario", inputUnit.value);
        formData.append("prezzo_treno", inputTreno.value);
        formData.append("disponibilita", quantitaSpan.textContent);

        try {
            const res = await fetch(`/modifica_gomma/${id}`, { method: "POST", body: formData });
            if(res.ok){
                alert("‚úÖ Gomma aggiornata correttamente.");
            } else { alert("‚ùå Errore durante l'aggiornamento."); }
        } catch(e){ console.error(e); alert("‚ùå Errore di comunicazione con il server."); }
    });

    // Elimina gomma tramite fetch al backend
    div.querySelector('.delete-gomma').addEventListener('click', async () => {
        if(!confirm('Sei sicuro di voler eliminare questa gomma?')) return;

        try {
            const res = await fetch(`/elimina_gomma/${id}`, { method: "POST" });
            if(res.ok){
                div.remove();
                alert("üóëÔ∏è Gomma eliminata correttamente.");
            } else { alert("‚ùå Errore durante l'eliminazione."); }
        } catch(e){ console.error(e); alert("‚ùå Errore di comunicazione con il server."); }
    });
});
{% endif %}
</script>
{% endblock %}
