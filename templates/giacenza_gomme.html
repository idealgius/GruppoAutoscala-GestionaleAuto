{% extends "base.html" %}

{% block title %}Giacenza Gomme{% endblock %}

{% block content %}
<h1 style="text-align:center; color:#004080; margin-bottom:30px;">üì¶ Giacenza Gomme</h1>

{% set solo_lettura = session.get('ruolo') == 'accettazione' %}

{% if gomme %}
    <!-- FILTRI -->
    <div style="max-width:900px; margin:0 auto 20px auto; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">

        <!-- WRAPPER PER MARCA -->
        <div class="select-wrapper">
            <select id="filtro-marca">
                <option value="">Tutte le marche</option>
                {% for m in gomme|map(attribute='marca')|unique|sort %}
                    <option value="{{ m }}">{{ m }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- WRAPPER PER MISURA -->
        <div class="select-wrapper">
            <select id="filtro-misura">
                <option value="">Tutte le misure</option>
                {% for g in gomme %}
                    {% set misura = g.larghezza ~ '/' ~ g.rapporto ~ ' R' ~ g.diametro %}
                    <option value="{{ misura }}">{{ misura }}</option>
                {% endfor %}
            </select>
        </div>

    </div>

    <div id="lista-gomme" style="max-width:900px; margin:0 auto; display:flex; flex-direction:column; gap:15px;">
        {% for g in gomme %}
        {% set misura = g.larghezza ~ '/' ~ g.rapporto ~ ' R' ~ g.diametro %}
        <div class="gomma-item"
             data-id="{{ g.id }}"
             data-marca="{{ g.marca }}"
             data-misura="{{ misura }}"
             style="padding:15px; border-radius:10px; background:#f2f2f2; box-shadow:0 2px 5px rgba(0,0,0,0.15);">

            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="flex:1;">
                    <strong style="font-size:18px;">{{ g.marca }}</strong>
                    <div style="font-size:16px; margin-bottom:5px;">
                        {{ misura }}
                    </div>

                    <div style="margin-top:8px;">
                        Prezzo unitario:
                        <input type="text" value="{{ g.prezzo_unitario }}"
                               class="prezzo-unitario"
                               style="width:70px;"
                               {% if solo_lettura %}readonly{% endif %}> ‚Ç¨

                        &nbsp;&nbsp;

                        Prezzo treno:
                        <input type="text" value="{{ g.prezzo_treno }}"
                               class="prezzo-treno"
                               style="width:70px;"
                               {% if solo_lettura %}readonly{% endif %}> ‚Ç¨
                    </div>

                    <div style="margin-top:10px;">
                        Disponibilit√†:
                        <button class="dec-disponibilita" style="padding:3px 6px;"
                                {% if solo_lettura %}disabled{% endif %}>-</button>
                        <span class="quantita" style="font-weight:bold; font-size:16px;">{{ g.disponibilita }}</span>
                        <button class="inc-disponibilita" style="padding:3px 6px;"
                                {% if solo_lettura %}disabled{% endif %}>+</button>
                    </div>

                    <!-- NOTE -->
                    <div style="margin-top:12px;">
                        <label><strong>Note:</strong></label><br>
                        <div class="nota-gomma-box" style="background:#fff; border:1px solid #ccc; padding:8px; border-radius:6px; min-height:50px; position:relative;">
                            <span class="nota-gomma-text">{{ g.note or 'Nessuna nota' }}</span>
                            {% if not solo_lettura %}
                            <textarea class="nota-gomma" style="width:100%; display:none; resize:vertical; min-height:50px;">{{ g.note or '' }}</textarea>
                            <button class="edit-nota" style="position:absolute; top:5px; right:5px; font-size:0.85em; padding:2px 6px; cursor:pointer;">‚úè Modifica</button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div>
                    {% if not solo_lettura %}
                    <button class="save-gomma"
                            style="margin-left:15px; padding:7px 12px; background:#28a745; color:white; border:none; border-radius:6px; cursor:pointer;">
                        üíæ Salva
                    </button>

                    <button class="delete-gomma"
                            style="margin-top:10px; margin-left:15px; padding:7px 12px; background:#dc3545; color:white; border:none; border-radius:6px; cursor:pointer;">
                        ‚ùå Elimina
                    </button>
                    {% endif %}
                </div>
            </div>

        </div>
        {% endfor %}
    </div>

{% else %}
    <p style="text-align:center; color:#666;">Nessuna gomma inserita.</p>
{% endif %}



<!-- ========================= -->
<!--     STILI CUSTOM SELECT   -->
<!-- ========================= -->
<style>
.select-wrapper {
    position: relative;
    display: inline-block;
}

.select-wrapper select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background: white;
    cursor: pointer;
}

.custom-select-panel {
    position: absolute;
    left: 0;
    right: 0;
    top: calc(100% + 2px);
    background: #ffffff;
    border: 2px solid #004080;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    max-height: 250px;
    overflow-y: auto;
    z-index: 9999;
    font-size: 14px;
}

.custom-select-panel .search-input {
    width: 100%;
    padding: 8px 10px;
    border: none;
    border-bottom: 1px solid #ccc;
    outline: none;
    font-size: 14px;
    box-sizing: border-box;
}

.custom-select-panel .opt-row {
    padding: 6px 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    background: #fff;
}

.custom-select-panel .opt-row:hover {
    background: #e7f1ff;
}

@media (max-width: 600px) {
    .select-wrapper {
        width: 100%;
    }
    .select-wrapper select {
        width: 100%;
    }
}
</style>



<!-- ========================= -->
<!--     SCRIPT COMPLETO      -->
<!-- ========================= -->
<script>

// üî• Normalizza le misure ‚Üí es. "185/55 R15" diventa "1855515"
function normalizzaMisura(str) {
    if (!str) return "";
    return str.replace(/[^0-9]/g, "");  // tiene solo numeri
}

// üî• Filtra la lista gomme
function filtraGomme(){
    const marca = document.getElementById("filtro-marca").value;
    const misura = document.getElementById("filtro-misura").value;

    const misuraNorm = normalizzaMisura(misura);

    document.querySelectorAll('.gomma-item').forEach(div=>{
        const matchMarca = !marca || div.dataset.marca === marca;

        const misuraItemNorm = normalizzaMisura(div.dataset.misura);
        const matchMisura = !misuraNorm || misuraItemNorm.startsWith(misuraNorm);

        div.style.display = (matchMarca && matchMisura) ? 'block' : 'none';
    });
}



// =============================
// üî• SELECT CON SEARCHBAR PRO
// =============================
function makeSearchableSelect(selectId) {

    const select = document.getElementById(selectId);
    const wrapper = select.parentElement;

    let panel = null;

    // Disattiva completamente menu nativo
    select.addEventListener("mousedown", e => e.preventDefault());

    function closePanel() {
        if (panel) { panel.remove(); panel = null; }
    }

    function openPanel() {
        closePanel();

        panel = document.createElement("div");
        panel.className = "custom-select-panel";

        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "Cerca...";
        input.className = "search-input";

        panel.appendChild(input);

        const options = Array.from(select.options).map(opt => ({
            text: opt.textContent,
            value: opt.value,
            norm: normalizzaMisura(opt.value)
        }));

        function render(term="") {
            panel.querySelectorAll(".opt-row").forEach(e => e.remove());

            const termNorm = normalizzaMisura(term);

            options
                .filter(o => !termNorm || o.norm.startsWith(termNorm))
                .sort((a,b)=> a.norm.localeCompare(b.norm))
                .forEach(o => {
                    const row = document.createElement("div");
                    row.className = "opt-row";
                    row.textContent = o.text;

                    row.addEventListener("click", () => {
                        select.value = o.value;
                        closePanel();
                        filtraGomme();
                    });

                    panel.appendChild(row);
                });
        }

        render("");

        input.addEventListener("input", () => {
            render(input.value);
        });

        wrapper.appendChild(panel);
        input.focus();

        setTimeout(()=>{
            document.addEventListener("click", function handler(e){
                if (!wrapper.contains(e.target)) {
                    closePanel();
                    document.removeEventListener("click", handler);
                }
            });
        }, 20);
    }

    select.addEventListener("click", e => {
        e.stopPropagation();
        panel ? closePanel() : openPanel();
    });
}

makeSearchableSelect("filtro-marca");
makeSearchableSelect("filtro-misura");



// =============================
// üî• FUNZIONI GOMME (quantit√†, note...)
// =============================
{% if not solo_lettura %}
document.querySelectorAll('.gomma-item').forEach(div => {

    const id = div.dataset.id;
    const qta = div.querySelector('.quantita');
    const prezzoUnit = div.querySelector('.prezzo-unitario');
    const prezzoTreno = div.querySelector('.prezzo-treno');

    const notaBox = div.querySelector('.nota-gomma-box');
    const notaText = notaBox.querySelector('.nota-gomma-text');
    const notaTextarea = notaBox.querySelector('.nota-gomma');
    const editBtn = notaBox.querySelector('.edit-nota');

    if(editBtn){
        editBtn.addEventListener('click', () => {
            notaText.style.display = 'none';
            notaTextarea.style.display = 'block';
            notaTextarea.focus();
        });
    }

    div.querySelector('.inc-disponibilita').addEventListener('click', () => {
        qta.textContent = parseInt(qta.textContent) + 1;
    });

    div.querySelector('.dec-disponibilita').addEventListener('click', () => {
        if(parseInt(qta.textContent) > 0){
            qta.textContent = parseInt(qta.textContent) - 1;
        }
    });

    div.querySelector('.save-gomma').addEventListener('click', async () => {
        const formData = new FormData();
        formData.append("prezzo_unitario", prezzoUnit.value.trim());
        formData.append("prezzo_treno", prezzoTreno.value.trim());
        formData.append("disponibilita", qta.textContent);
        formData.append("note", notaTextarea.value.trim());

        try {
            const res = await fetch(`/modifica_gomma/${id}`, { method: "POST", body: formData });
            if(res.ok){
                alert("‚úî Gomma aggiornata correttamente.");
                notaText.textContent = notaTextarea.value.trim() || 'Nessuna nota';
                notaTextarea.style.display = 'none';
                notaText.style.display = 'block';
            } else {
                alert("‚ùå Errore durante l'aggiornamento.");
            }
        } catch(e){
            alert("‚ùå Errore di comunicazione con il server.");
        }
    });

    div.querySelector('.delete-gomma').addEventListener('click', async () => {
        if(!confirm('Eliminare questa gomma?')) return;

        try {
            const res = await fetch(`/elimina_gomma/${id}`, { method: "POST" });
            if(res.ok){
                div.remove();
                alert("üóëÔ∏è Gomma eliminata.");
            } else {
                alert("‚ùå Errore durante l'eliminazione.");
            }
        } catch(e){
            alert("‚ùå Errore di comunicazione con il server.");
        }
    });

});
{% endif %}
</script>

{% endblock %}
