{% extends "base.html" %}

{% block title %}Giacenza Gomme{% endblock %}

{% block content %}
<h1 style="text-align:center; color:#004080; margin-bottom:30px;">üì¶ Giacenza Gomme</h1>

{% set solo_lettura = session.get('ruolo') == 'accettazione' %}

{% if gomme %}
    <!-- FILTRI -->
    <div style="max-width:900px; margin:0 auto 20px auto; display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
        <select id="filtro-marca">
            <option value="">Tutte le marche</option>
            {% for m in gomme|map(attribute='marca')|unique|sort %}
                <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
        </select>

        <select id="filtro-misura">
            <option value="">Tutte le misure</option>
            {% for g in gomme %}
                {% set misura = g.larghezza ~ '/' ~ g.rapporto ~ ' R' ~ g.diametro %}
                <option value="{{ misura }}">{{ misura }}</option>
            {% endfor %}
        </select>
    </div>

    <div id="lista-gomme" style="max-width:900px; margin:0 auto; display:flex; flex-direction:column; gap:15px;">
        {% for g in gomme %}
        {% set misura = g.larghezza ~ '/' ~ g.rapporto ~ ' R' ~ g.diametro %}
        <div class="gomma-item"
             data-id="{{ g.id }}"
             data-marca="{{ g.marca }}"
             data-misura="{{ misura }}"
             style="padding:15px; border-radius:10px; background:#f2f2f2; box-shadow:0 2px 5px rgba(0,0,0,0.15);">

            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div style="flex:1;">
                    <strong style="font-size:18px;">{{ g.marca }}</strong>
                    <div style="font-size:16px; margin-bottom:5px;">
                        {{ misura }}
                    </div>

                    <div style="margin-top:8px;">
                        Prezzo unitario:
                        <input type="text" value="{{ g.prezzo_unitario }}"
                               class="prezzo-unitario"
                               style="width:70px;"
                               {% if solo_lettura %}readonly{% endif %}> ‚Ç¨

                        &nbsp;&nbsp;

                        Prezzo treno:
                        <input type="text" value="{{ g.prezzo_treno }}"
                               class="prezzo-treno"
                               style="width:70px;"
                               {% if solo_lettura %}readonly{% endif %}> ‚Ç¨
                    </div>

                    <div style="margin-top:10px;">
                        Disponibilit√†:
                        <button class="dec-disponibilita" style="padding:3px 6px;"
                                {% if solo_lettura %}disabled{% endif %}>-</button>
                        <span class="quantita" style="font-weight:bold; font-size:16px;">{{ g.disponibilita }}</span>
                        <button class="inc-disponibilita" style="padding:3px 6px;"
                                {% if solo_lettura %}disabled{% endif %}>+</button>
                    </div>

                    <!-- NOTE -->
                    <div style="margin-top:12px;">
                        <label><strong>Note:</strong></label><br>
                        <textarea class="nota-gomma"
                                  rows="2"
                                  style="width:95%; resize:vertical;"
                                  {% if solo_lettura %}readonly{% endif %}>{{ g.note or '' }}</textarea>
                    </div>
                </div>

                <div>
                    {% if not solo_lettura %}
                    <button class="save-gomma"
                            style="margin-left:15px; padding:7px 12px; background:#28a745; color:white; border:none; border-radius:6px; cursor:pointer;">
                        üíæ Salva
                    </button>

                    <button class="delete-gomma"
                            style="margin-top:10px; margin-left:15px; padding:7px 12px; background:#dc3545; color:white; border:none; border-radius:6px; cursor:pointer;">
                        ‚ùå Elimina
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <p style="text-align:center; color:#666;">Nessuna gomma inserita.</p>
{% endif %}

<script>
// --- FILTRI ---
const filtroMarca = document.getElementById('filtro-marca');
const filtroMisura = document.getElementById('filtro-misura');

function filtraGomme(){
    const marca = filtroMarca.value;
    const misura = filtroMisura.value;

    document.querySelectorAll('.gomma-item').forEach(div=>{
        const matchMarca = !marca || div.dataset.marca === marca;
        const matchMisura = !misura || div.dataset.misura === misura;
        div.style.display = (matchMarca && matchMisura) ? 'block' : 'none';
    });
}

if(filtroMarca) filtroMarca.addEventListener('change', filtraGomme);
if(filtroMisura) filtroMisura.addEventListener('change', filtraGomme);

// --- FUNZIONALIT√Ä SOLO SE NON SOLO_LETTURA ---
{% if not solo_lettura %}
document.querySelectorAll('.gomma-item').forEach(div => {
    const id = div.dataset.id;
    const qta = div.querySelector('.quantita');
    const prezzoUnit = div.querySelector('.prezzo-unitario');
    const prezzoTreno = div.querySelector('.prezzo-treno');
    const note = div.querySelector('.nota-gomma');

    // Incrementa
    div.querySelector('.inc-disponibilita').addEventListener('click', () => {
        qta.textContent = parseInt(qta.textContent) + 1;
    });

    // Decrementa
    div.querySelector('.dec-disponibilita').addEventListener('click', () => {
        if(parseInt(qta.textContent) > 0){
            qta.textContent = parseInt(qta.textContent) - 1;
        }
    });

    // Salvataggio
    div.querySelector('.save-gomma').addEventListener('click', async () => {
        const formData = new FormData();
        formData.append("prezzo_unitario", prezzoUnit.value);
        formData.append("prezzo_treno", prezzoTreno.value);
        formData.append("disponibilita", qta.textContent);
        formData.append("note", note.value);

        try {
            const res = await fetch(`/modifica_gomma/${id}`, { method: "POST", body: formData });
            if(res.ok){
                alert("‚úî Gomma aggiornata correttamente.");
            } else {
                alert("‚ùå Errore durante l'aggiornamento.");
            }
        } catch(e){
            alert("‚ùå Errore di comunicazione con il server.");
        }
    });

    // Eliminazione
    div.querySelector('.delete-gomma').addEventListener('click', async () => {
        if(!confirm('Eliminare questa gomma?')) return;

        try {
            const res = await fetch(`/elimina_gomma/${id}`, { method: "POST" });
            if(res.ok){
                div.remove();
                alert("üóëÔ∏è Gomma eliminata.");
            } else {
                alert("‚ùå Errore durante l'eliminazione.");
            }
        } catch(e){
            alert("‚ùå Errore di comunicazione con il server.");
        }
    });
});
{% endif %}
</script>

{% endblock %}
