{% extends "base.html" %}

{% block title %}Ricambi per Modello{% endblock %}

{% block content %}
<h1>üîó Ricambi per: {{ modello['marca'] }} {{ modello['modello'] }}</h1>

<div style="display:flex; gap:20px; align-items:center; margin-bottom:18px; flex-wrap: wrap;">
  <a class="button" href="{{ url_for('lista_modelli') }}">üîô Torna ai modelli</a>
  <div style="color:#666;">Modello ID: {{ modello['id'] }}</div>
</div>

<h3>Ricambi associati</h3>
{% if associati %}
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Nome</th>
      <th>Codice</th>
      <th>Tipo Filtro</th>
      <th>Azioni</th>
    </tr>
  </thead>
  <tbody>
    {% for r in associati %}
    <tr>
      <td>{{ r['id'] }}</td>
      <td>{{ r['nome'] }}</td>
      <td>{{ r['codice'] }}</td>
      <td>{{ r.get('tipo_filtro', '') }}</td>
      <td class="action-buttons">
        <form action="{{ url_for('rimuovi_ricambio_da_modello', modello_id=modello['id'], ricambio_id=r['id']) }}" method="POST" style="display:inline;">
          <button type="submit" class="elimina">‚ùå Rimuovi</button>
        </form>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<p>Nessun ricambio associato a questo modello.</p>
{% endif %}

<hr style="margin:18px 0;" />

<h3>Aggiungi ricambio al modello</h3>
{% if non_associati %}
<form action="{{ url_for('aggiungi_ricambio_a_modello', modello_id=modello['id']) }}" method="POST" style="max-width:600px;">
  <label for="tipo_filtro">Tipo di filtro:</label>
  <select name="tipo_filtro" id="tipo_filtro" required>
    <option value="">-- Seleziona tipo filtro --</option>
    <option value="Filtro Olio">Filtro Olio</option>
    <option value="Filtro Aria">Filtro Aria</option>
    <option value="Filtro Abitacolo">Filtro Abitacolo</option>
  </select>

  <label for="ricambio_id">Scegli ricambio:</label>
  <select name="ricambio_id" id="ricambio_id" required>
    <option value="">-- Seleziona tipo filtro prima --</option>
  </select>

  <button type="submit" style="margin-top:10px;">‚ûï Associa ricambio</button>
</form>

<script>
  // Lista dei ricambi non associati passata dal template
  const ricambi = {{ non_associati|tojson }};
  const tipoFiltroSelect = document.getElementById('tipo_filtro');
  const ricambioSelect = document.getElementById('ricambio_id');

  tipoFiltroSelect.addEventListener('change', () => {
    const tipoSelezionato = tipoFiltroSelect.value;
    ricambioSelect.innerHTML = '<option value="">-- Seleziona --</option>';

    ricambi.forEach(r => {
      const nomeLower = r.nome.toLowerCase();
      if ((tipoSelezionato === 'Filtro Olio' && nomeLower.includes('olio')) ||
          (tipoSelezionato === 'Filtro Aria' && nomeLower.includes('aria')) ||
          (tipoSelezionato === 'Filtro Abitacolo' && nomeLower.includes('abitacolo'))) {
        const option = document.createElement('option');
        option.value = r.id;
        option.text = r.nome + ' ‚Äî ' + r.codice;
        ricambioSelect.appendChild(option);
      }
    });
  });
</script>
{% else %}
<p>Tutti i ricambi disponibili sono gi√† associati a questo modello (o non esistono ricambi).</p>
{% endif %}
{% endblock %}
